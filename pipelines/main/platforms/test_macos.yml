steps:
  - group: ":macos: Macos"
    steps:
      - label: ":macos: :test_tube: test ${TRIPLET?}"
        key: "test_${TRIPLET?}"
        depends_on:
          - "build_${TRIPLET?}"
        plugins:
          - JuliaCI/external-buildkite#v1:
              version: ".buildkite-external-version"
              repo_url: "https://github.com/JuliaCI/julia-buildkite"
        env:
          JULIA_SHELL: "/bin/bash"
        timeout_in_minutes: ${TIMEOUT?}
        soft_fail: ${ALLOW_FAIL?}
        commands: |
          # First, get things like `LONG_COMMIT` and `SHORT_COMMIT`, etc...
          TRIPLET="${TRIPLET?}" source .buildkite/utilities/calc_version_envs.sh

          echo "--- Download build artifacts"
          buildkite-agent artifact download "$${UPLOAD_FILENAME}" .

          echo "--- Extract build artifacts"
          tar xzf "$${UPLOAD_FILENAME}" "$${JULIA_INSTALL_DIR}/"

          echo "--- Ad-hoc sign for testing"
          contrib/codesign.sh "-" "$${JULIA_INSTALL_DIR}"

          echo "--- Print Julia version info"
          $${JULIA_BINARY} -e 'using InteractiveUtils; InteractiveUtils.versioninfo()'
          echo "JULIA_CPU_THREADS is: $${JULIA_CPU_THREADS}"
          $${JULIA_BINARY} -e '@info "" Sys.CPU_THREADS'

          echo "--- Set some environment variables"
          export OPENBLAS_NUM_THREADS=4
          unset JULIA_DEPOT_PATH
          unset JULIA_PKG_SERVER

          # By default, run all tests.
          export TESTS="all LibGit2/online --ci"

          export JULIA_CMD_FOR_TESTS="$${JULIA_BINARY}"
          export NCORES_FOR_TESTS="Sys.CPU_THREADS"


          echo "--- Print the list of test sets, and other useful environment variables"
          echo "JULIA_CMD_FOR_TESTS is:    $${JULIA_CMD_FOR_TESTS:?}"
          echo "JULIA_NUM_THREADS is:      $${JULIA_NUM_THREADS}" # Note: this environment variable might not be set
          echo "NCORES_FOR_TESTS is:       $${NCORES_FOR_TESTS:?}"
          echo "OPENBLAS_NUM_THREADS is:   $${OPENBLAS_NUM_THREADS:?}"
          echo "TESTS is:                  $${TESTS:?}"

          echo "--- Run the Julia test suite"
          $${JULIA_CMD_FOR_TESTS:?} -e "Base.runtests(\"$${TESTS:?}\"; ncores = $${NCORES_FOR_TESTS:?})"
        agents:
          queue: "julia"
          os: "macos"
          arch: "${ARCH}"
