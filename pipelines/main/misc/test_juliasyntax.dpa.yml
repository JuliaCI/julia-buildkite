steps:
  - group: "Check"
    steps:
      - label: "test juliasyntax" # TODO: come up with better name
        # key: "test-juliasyntax" # TODO: Fix this
        timeout_in_minutes: 30
        agents:
          queue: "julia"
          os: "{{matrix.os}}"
          arch: "{{matrix.agent_arch}}"
        matrix:
          setup:
            os:
              - "linux"
              # - "macos" # We handle macos special, see "adjustments" section below
              - "windows"
            agent_arch: # architecture of the Buildkite agent. Distinct from the Julia binary's architecture.
              - "x86_64" # The "x86_64" agent architectuere is used for both 32-bit Julia and 64-bit Julia
            julia_arch: # architecture of the Julia binary to install. Distinct from the agent architecture.
              - "x86_64" # 64-bit
              - "x86" # 32-bit # TODO: uncomment this line
            julia_version:
              # Don't put "1" here. Always include at least major and minor version.
              - "1.10"
              - "1.11"
              - "1.12"
          adjustments:
            # macOS x86_64:
            - with:
                os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.10"
            - with:
                os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.11"
            - with:
                os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.12"
            # macOS arm64:
            - with:
                os: "macos"
                agent_arch: "arm64"
                julia_arch: "arm64"
                julia_version: "1.10"
            - with:
                os: "macos"
                agent_arch: "arm64"
                julia_arch: "arm64"
                julia_version: "1.11"
            - with:
                os: "macos"
                agent_arch: "arm64"
                julia_arch: "arm64"
                julia_version: "1.12"
        plugins:
          - JuliaCI/external-buildkite#v1:
              version: "./.buildkite-external-version"
              repo_url: "https://github.com/JuliaCI/julia-buildkite"
          - JuliaCI/julia#v1:
              isolated_depot: true
              # Drop default "registries" directory, so it is not persisted from execution to execution
              persist_depot_dirs: packages,artifacts,compiled
              version: '{{matrix.julia_version}}'
              arch: '{{matrix.julia_arch}}'
        commands: |
          echo "--- Pkg.dev-ing (by path) the local copy of JuliaSyntax"
          export JULIA_PKG_PRECOMPILE_AUTO=0
          julia -e 'import Pkg; pspec = Pkg.PackageSpec(path = "./JuliaSyntax"); Pkg.develop(pspec)'

          echo "--- Testing JuliaSyntax on Julia {{matrix.julia_version}}"
          unset JULIA_PKG_PRECOMPILE_AUTO
          julia -e 'import Pkg; Pkg.test("JuliaSyntax")'
          JULIA_PKG_PRECOMPILE_AUTO=0 ./julia -e 'using Pkg; Pkg.add(name="JuliaSyntax", rev="master"); ENV["JULIA_PKG_PRECOMPILE_AUTO"]=1; Pkg.test("JuliaSyntax")'
