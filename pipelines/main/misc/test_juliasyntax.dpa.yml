steps:
  - group: "Check"
    steps:
      - label: "juliasyntax {{matrix.agent_os}}/{{matrix.agent_arch}}/{{matrix.julia_version}}/{{matrix.julia_arch}}" # TODO: come up with better name.
        # key: "juliasyntax-key" # TODO: Figure out if we can define a Buildkite key here.
        timeout_in_minutes: 30
        agents:
          queue: "julia"
          os: "{{matrix.agent_os}}"
          arch: "{{matrix.agent_arch}}"
        matrix:
          setup:
            agent_os:
              - "linux"
              - "windows"
              # - "macos" # We handle macOS special, see "adjustments" section below
            agent_arch: # architecture of the Buildkite agent. Distinct from the Julia binary's architecture
              - "x86_64" # The "x86_64" agent architectuere is used for both 32-bit Julia and 64-bit Julia
            julia_arch: # architecture of the Julia binary to install. Distinct from the agent architecture
              - "x86_64" # 64-bit Julia
              # - "i686" # 32-bit Julia # TODO: Uncomment this line and fix the problems with i686.
            julia_version:
              # Don't put "1" here. Always include at least major and minor version.
              - "1.0"
              - "1.6" # old LTS
              - "1.10" # current LTS
              - "1.12" # latest stable
          adjustments:
            # macOS x86_64 (Intel):
            - with:
                agent_os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.0"
            - with:
                agent_os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.6" # old LTS
            - with:
                agent_os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.10" # current LTS
            - with:
                agent_os: "macos"
                agent_arch: "x86_64"
                julia_arch: "x86_64"
                julia_version: "1.12" # latest stable
            # macOS aarch64 (Apple Silicon):
            # Note: Julia 1.0 and 1.6 did not have native aarch64 binaries for macOS, so we skip those
            - with:
                agent_os: "macos"
                agent_arch: "aarch64"
                julia_arch: "aarch64"
                julia_version: "1.10" # old LTS
            - with:
                agent_os: "macos"
                agent_arch: "aarch64"
                julia_arch: "aarch64"
                julia_version: "1.12" # latest stable
        plugins:
          - JuliaCI/external-buildkite#v1:
              version: "./.buildkite-external-version"
              repo_url: "https://github.com/JuliaCI/julia-buildkite"
          - JuliaCI/julia#v1:
              isolated_depot: true
              # Drop default "registries" directory, so it is not persisted from execution to execution
              persist_depot_dirs: packages,artifacts,compiled
              version: '{{matrix.julia_version}}'
              arch: '{{matrix.julia_arch}}'
        commands: |
          echo "--- Pkg.dev-ing (by path) the local copy of JuliaSyntax"
          export JULIA_PKG_PRECOMPILE_AUTO=0
          julia -e 'import Pkg; pspec = Pkg.PackageSpec(path = "./JuliaSyntax"); Pkg.develop(pspec)'

          echo "--- Testing JuliaSyntax on Julia {{matrix.julia_version}}"
          unset JULIA_PKG_PRECOMPILE_AUTO
          julia -e 'import Pkg; Pkg.test("JuliaSyntax")'
