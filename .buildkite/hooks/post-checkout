#!/bin/bash

echo 'Running post-checkout hook'
echo 'Let us see where we are:'
pwd
echo 'and what we need to clean up:'
ls -alh
echo 'remove current contents of build directory'
ls -A1 | xargs rm -rf
echo 'Clone julia, main branch only:'
git clone -b master https://github.com/JuliaLang/Julia ./
echo 'Check if BUILDKITE_COMMIT is set'
echo $BUILDKITE_COMMIT
echo 'Set environement variables that will be used by external-buildkite'
EXTERNAL_JULIA_IGNORE_FILE=true
EXTERNAL_JULIA_USE_COMMIT=${BUILDKITE_COMMIT?:}
echo 'Create temporary pipeline.yaml to call external-buildkite plugin'
cat >.buildkite/pipeline.yaml <<EOL
steps:
  - plugins:
    - JuliaCI/external-buildkite:
        this_is_first_job: true
        version_file: 'buildkite.version'
        external_repo: 'https://github.com/JuliaCI/julia-buildkite.git'
        folder: '.buildkite'
EOL

ls -alh
